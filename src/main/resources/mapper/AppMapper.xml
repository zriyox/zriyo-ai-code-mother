<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zriyo.aicodemother.mapper.AppMapper">

    <!-- 查询列表 -->
    <select id="selectAppWithUserList" resultType="com.zriyo.aicodemother.model.vo.AppPageVO">
        SELECT
        a.id,
        a.appName AS appName,
        a.priority,
        a.createTime AS createTime,
        a.deployKey,
        u.userName ,
        u.userAvatar,
        a.cover,
        a.deployedTime
        FROM app a
        LEFT JOIN user u ON a.userId = u.id
        WHERE a.is_published = 1
        <if test="appName != null and appName != ''">
            AND a.appName LIKE CONCAT('%', #{appName}, '%')
        </if>
        AND a.isDelete = 0
        ORDER BY a.priority DESC, a.createTime DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询总数 -->
    <select id="countAppWithUser" resultType="long">
        SELECT COUNT(1)
        FROM app a
        WHERE a.is_published = 1
        <if test="appName != null and appName != ''">
            AND a.appName LIKE CONCAT('%', #{appName}, '%')
        </if>
        AND a.isDelete = 0
    </select>

    <!-- 批量统计用户的应用数 -->
    <select id="countAppByUserIds" resultType="map">
        SELECT userId, COUNT(*) as appCount
        FROM app
        WHERE userId IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
        AND isDelete = 0
        GROUP BY userId
    </select>
</mapper>
