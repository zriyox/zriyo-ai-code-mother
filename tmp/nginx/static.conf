pid        /Users/zriyo/Desktop/zriyo-ai-code-mother/tmp/nginx/nginx.pid;
error_log  /Users/zriyo/Desktop/zriyo-ai-code-mother/tmp/nginx/error.log warn;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /opt/homebrew/etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    gzip on;

    server {
        listen 8888;
        server_name localhost;
        root "/Users/zriyo/Desktop/zriyo-ai-code-mother/tmp/code_output/code_deploy";
        index index.html;

        charset utf-8;
        charset_types text/css application/javascript text/plain text/xml application/json;

        # =============== 统一处理所有 HTML 响应 ===============
        location ~ \.html$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            sub_filter '/assets/' './assets/';
            sub_filter_once off;
            sub_filter_types text/html;   # ← 只在这里写一次！
            try_files $uri =404;
        }

        # =============== SPA 子目录路由支持 ===============
        location ~ ^/(?<appdir>[^/]+)/ {
            # 如果是文件（如 .js, .css, .png），直接返回
            try_files $uri $uri/ @spa;
        }

        location @spa {
            rewrite ^/(?<appdir>[^/]+)(/.*)?$ /$appdir/index.html last;
        }

        # =============== 静态资源缓存 ===============
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2|woff|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # =============== 根路径 ===============
        location = / {
            try_files /index.html =404;
        }

        error_log /Users/zriyo/Desktop/zriyo-ai-code-mother/tmp/nginx/error.log warn;
    }
}
